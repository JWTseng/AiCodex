<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .status.warning {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ff9800;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .audio-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .volume-slider {
            width: 150px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”Š éŸ³é¢‘ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š éŸ³é¢‘çŠ¶æ€æ£€æµ‹</h3>
            <div id="audioStatus" class="status warning">
                â³ æ­£åœ¨æ£€æµ‹éŸ³é¢‘ç³»ç»Ÿ...
            </div>
            <div id="browserInfo" class="status">
                <strong>æµè§ˆå™¨ä¿¡æ¯:</strong> <span id="browserName">-</span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸµ éŸ³é¢‘åŠŸèƒ½æµ‹è¯•</h3>
            <div class="audio-controls">
                <button onclick="testAudioContext()">æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡</button>
                <button onclick="testSFX()">æµ‹è¯•éŸ³æ•ˆ</button>
                <button onclick="testMusic()">æµ‹è¯•éŸ³ä¹</button>
                <button onclick="testVolume()">æµ‹è¯•éŸ³é‡æ§åˆ¶</button>
            </div>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ›ï¸ éŸ³é‡æ§åˆ¶</h3>
            <div class="volume-control">
                <label>ä¸»éŸ³é‡:</label>
                <input type="range" id="masterVolume" class="volume-slider" min="0" max="1" step="0.1" value="0.3">
                <span id="masterVolumeValue">30%</span>
            </div>
            <div class="volume-control">
                <label>éŸ³ä¹éŸ³é‡:</label>
                <input type="range" id="musicVolume" class="volume-slider" min="0" max="1" step="0.1" value="0.3">
                <span id="musicVolumeValue">30%</span>
            </div>
            <div class="volume-control">
                <label>éŸ³æ•ˆéŸ³é‡:</label>
                <input type="range" id="sfxVolume" class="volume-slider" min="0" max="1" step="0.1" value="0.8">
                <span id="sfxVolumeValue">80%</span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ® æ¸¸æˆéŸ³é¢‘æµ‹è¯•</h3>
            <div class="audio-controls">
                <button onclick="loadGameAudio()">åŠ è½½æ¸¸æˆéŸ³é¢‘</button>
                <button onclick="testGameSFX()">æµ‹è¯•æ¸¸æˆéŸ³æ•ˆ</button>
                <button onclick="testGameMusic()">æµ‹è¯•æ¸¸æˆéŸ³ä¹</button>
            </div>
            <div id="gameAudioResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æ•…éšœæ’é™¤</h3>
            <ul>
                <li><strong>æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥:</strong> ç°ä»£æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é¢‘</li>
                <li><strong>éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€:</strong> æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡æ˜¯å¦è¢«æš‚åœ</li>
                <li><strong>éŸ³é‡è®¾ç½®:</strong> ç¡®ä¿éŸ³é‡ä¸ä¸º0</li>
                <li><strong>éŸ³é¢‘æ–‡ä»¶:</strong> æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½</li>
            </ul>
            <button onclick="diagnoseAudio()">è¯Šæ–­éŸ³é¢‘é—®é¢˜</button>
            <div id="diagnosisResults"></div>
        </div>
    </div>

    <script>
        let audioManager = null;
        let audioContext = null;

        // æ£€æµ‹æµè§ˆå™¨ä¿¡æ¯
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browserName = 'Unknown';
            
            if (userAgent.includes('Chrome')) browserName = 'Chrome';
            else if (userAgent.includes('Firefox')) browserName = 'Firefox';
            else if (userAgent.includes('Safari')) browserName = 'Safari';
            else if (userAgent.includes('Edge')) browserName = 'Edge';
            
            document.getElementById('browserName').textContent = browserName;
        }

        // æ£€æµ‹éŸ³é¢‘æ”¯æŒ
        function detectAudioSupport() {
            const status = document.getElementById('audioStatus');
            
            // æ£€æŸ¥Web Audio APIæ”¯æŒ
            if (!window.AudioContext && !window.webkitAudioContext) {
                status.className = 'status error';
                status.innerHTML = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API';
                return false;
            }
            
            // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»º
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                status.className = 'status success';
                status.innerHTML = 'âœ… éŸ³é¢‘ç³»ç»Ÿæ”¯æŒæ­£å¸¸';
                return true;
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºå¤±è´¥: ${error.message}`;
                return false;
            }
        }

        // æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡
        function testAudioContext() {
            const results = document.getElementById('testResults');
            
            if (!audioContext) {
                results.innerHTML = '<div class="status error">âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–</div>';
                return;
            }
            
            let status = `<div class="status success">âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€: ${audioContext.state}</div>`;
            
            if (audioContext.state === 'suspended') {
                status += '<div class="status warning">âš ï¸ éŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ¿€æ´»</div>';
            }
            
            results.innerHTML = status;
        }

        // æµ‹è¯•éŸ³æ•ˆ
        function testSFX() {
            const results = document.getElementById('testResults');
            
            if (!audioContext) {
                results.innerHTML = '<div class="status error">âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–</div>';
                return;
            }
            
            try {
                // åˆ›å»ºæµ‹è¯•éŸ³æ•ˆ
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                
                results.innerHTML = '<div class="status success">âœ… éŸ³æ•ˆæ’­æ”¾æˆåŠŸ</div>';
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ éŸ³æ•ˆæ’­æ”¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•éŸ³ä¹
        function testMusic() {
            const results = document.getElementById('testResults');
            
            if (!audioContext) {
                results.innerHTML = '<div class="status error">âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–</div>';
                return;
            }
            
            try {
                // åˆ›å»ºç®€å•çš„éŸ³ä¹åºåˆ—
                const notes = [440, 494, 523, 587, 659, 698, 784];
                let currentTime = audioContext.currentTime;
                
                notes.forEach((frequency, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, currentTime);
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0.2, currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.2);
                    
                    oscillator.start(currentTime);
                    oscillator.stop(currentTime + 0.2);
                    
                    currentTime += 0.2;
                });
                
                results.innerHTML = '<div class="status success">âœ… éŸ³ä¹æ’­æ”¾æˆåŠŸ</div>';
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ éŸ³ä¹æ’­æ”¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•éŸ³é‡æ§åˆ¶
        function testVolume() {
            const results = document.getElementById('testResults');
            
            if (!audioContext) {
                results.innerHTML = '<div class="status error">âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–</div>';
                return;
            }
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.type = 'sine';
                
                // æµ‹è¯•éŸ³é‡å˜åŒ–
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                results.innerHTML = '<div class="status success">âœ… éŸ³é‡æ§åˆ¶æµ‹è¯•æˆåŠŸ</div>';
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ éŸ³é‡æ§åˆ¶æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æ¸¸æˆéŸ³é¢‘
        function loadGameAudio() {
            const results = document.getElementById('gameAudioResults');
            
            try {
                // åŠ¨æ€åŠ è½½audio.js
                const script = document.createElement('script');
                script.src = 'Tetris_Standalone/audio.js';
                script.onload = function() {
                    if (typeof NESTetrisAudio !== 'undefined') {
                        audioManager = new NESTetrisAudio();
                        results.innerHTML = '<div class="status success">âœ… æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨åŠ è½½æˆåŠŸ</div>';
                    } else {
                        results.innerHTML = '<div class="status error">âŒ æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨åŠ è½½å¤±è´¥</div>';
                    }
                };
                script.onerror = function() {
                    results.innerHTML = '<div class="status error">âŒ æ— æ³•åŠ è½½audio.jsæ–‡ä»¶</div>';
                };
                document.head.appendChild(script);
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ åŠ è½½æ¸¸æˆéŸ³é¢‘å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•æ¸¸æˆéŸ³æ•ˆ
        function testGameSFX() {
            const results = document.getElementById('gameAudioResults');
            
            if (!audioManager) {
                results.innerHTML = '<div class="status error">âŒ æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨æœªåŠ è½½</div>';
                return;
            }
            
            try {
                audioManager.playSFX('move');
                results.innerHTML = '<div class="status success">âœ… æ¸¸æˆéŸ³æ•ˆæ’­æ”¾æˆåŠŸ</div>';
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ æ¸¸æˆéŸ³æ•ˆæ’­æ”¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•æ¸¸æˆéŸ³ä¹
        function testGameMusic() {
            const results = document.getElementById('gameAudioResults');
            
            if (!audioManager) {
                results.innerHTML = '<div class="status error">âŒ æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨æœªåŠ è½½</div>';
                return;
            }
            
            try {
                audioManager.generateBackgroundMusic('music1');
                results.innerHTML = '<div class="status success">âœ… æ¸¸æˆéŸ³ä¹æ’­æ”¾æˆåŠŸ</div>';
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ æ¸¸æˆéŸ³ä¹æ’­æ”¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¯Šæ–­éŸ³é¢‘é—®é¢˜
        function diagnoseAudio() {
            const results = document.getElementById('diagnosisResults');
            let diagnosis = '<h4>ğŸ” éŸ³é¢‘è¯Šæ–­ç»“æœ:</h4>';
            
            // æ£€æŸ¥Web Audio API
            if (!window.AudioContext && !window.webkitAudioContext) {
                diagnosis += '<div class="status error">âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API</div>';
            } else {
                diagnosis += '<div class="status success">âœ… Web Audio APIæ”¯æŒæ­£å¸¸</div>';
            }
            
            // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioContext) {
                diagnosis += `<div class="status success">âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆ›å»ºï¼ŒçŠ¶æ€: ${audioContext.state}</div>`;
                if (audioContext.state === 'suspended') {
                    diagnosis += '<div class="status warning">âš ï¸ éŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ¿€æ´»</div>';
                }
            } else {
                diagnosis += '<div class="status error">âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆ›å»º</div>';
            }
            
            // æ£€æŸ¥æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨
            if (audioManager) {
                diagnosis += '<div class="status success">âœ… æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨å·²åŠ è½½</div>';
            } else {
                diagnosis += '<div class="status error">âŒ æ¸¸æˆéŸ³é¢‘ç®¡ç†å™¨æœªåŠ è½½</div>';
            }
            
            // æ£€æŸ¥éŸ³é‡è®¾ç½®
            const masterVolume = document.getElementById('masterVolume').value;
            const musicVolume = document.getElementById('musicVolume').value;
            const sfxVolume = document.getElementById('sfxVolume').value;
            
            if (masterVolume == 0) {
                diagnosis += '<div class="status warning">âš ï¸ ä¸»éŸ³é‡ä¸º0</div>';
            }
            if (musicVolume == 0) {
                diagnosis += '<div class="status warning">âš ï¸ éŸ³ä¹éŸ³é‡ä¸º0</div>';
            }
            if (sfxVolume == 0) {
                diagnosis += '<div class="status warning">âš ï¸ éŸ³æ•ˆéŸ³é‡ä¸º0</div>';
            }
            
            results.innerHTML = diagnosis;
        }

        // éŸ³é‡æ§åˆ¶äº‹ä»¶
        document.getElementById('masterVolume').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('masterVolumeValue').textContent = Math.round(value * 100) + '%';
            if (audioManager) {
                audioManager.setMasterVolume(parseFloat(value));
            }
        });

        document.getElementById('musicVolume').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('musicVolumeValue').textContent = Math.round(value * 100) + '%';
            if (audioManager) {
                audioManager.setMusicVolume(parseFloat(value));
            }
        });

        document.getElementById('sfxVolume').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('sfxVolumeValue').textContent = Math.round(value * 100) + '%';
            if (audioManager) {
                audioManager.setSFXVolume(parseFloat(value));
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            detectBrowser();
            detectAudioSupport();
        });

        // ç”¨æˆ·äº¤äº’æ—¶æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
        document.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
                document.getElementById('testResults').innerHTML = '<div class="status success">âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¿€æ´»</div>';
            }
        });
    </script>
</body>
</html>

