<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG3 舒适Combo音效测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .section h2 {
            color: #ffd700;
            margin-top: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }
        .game-container {
            text-align: center;
            margin: 20px 0;
        }
        .game-frame {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: #000;
            margin: 20px auto;
            display: block;
        }
        .info-box {
            background: rgba(33, 150, 243, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin: 15px 0;
        }
        .info-box h3 {
            color: #2196f3;
            margin-top: 0;
        }
        .success-box {
            background: rgba(76, 175, 80, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 15px 0;
        }
        .success-box h3 {
            color: #4caf50;
            margin-top: 0;
        }
        .warning-box {
            background: rgba(255, 152, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 15px 0;
        }
        .warning-box h3 {
            color: #ff9800;
            margin-top: 0;
        }
        .combo-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .combo-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        .combo-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        .combo-button:active {
            transform: translateY(0);
            background: rgba(255, 215, 0, 0.3);
        }
        .combo-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .combo-button:active::before {
            left: 100%;
        }
        .combo-2 { border-left-color: #4caf50; }
        .combo-3 { border-left-color: #2196f3; }
        .combo-4 { border-left-color: #ff9800; }
        .combo-5 { border-left-color: #f44336; }
        .combo-6 { border-left-color: #9c27b0; }
        .combo-7 { border-left-color: #e91e63; }
        .combo-8 { border-left-color: #ff5722; }
        .combo-9 { border-left-color: #795548; }
        .combo-10 { border-left-color: #ffd700; }
        .combo-high { border-left-color: #ff1744; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .comparison-table th {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-weight: bold;
        }
        .comparison-table td {
            background: rgba(255, 255, 255, 0.1);
        }
        .new-design {
            background: rgba(76, 175, 80, 0.2) !important;
            color: #4caf50 !important;
            font-weight: bold;
        }
        .audio-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .feature-card h4 {
            color: #ffd700;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .feature-card ul {
            padding-left: 20px;
        }
        .feature-card li {
            margin: 8px 0;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 TG3 舒适Combo音效测试</h1>
        
        <div class="success-box">
            <h3>✅ 钢琴音阶Combo音效已实施</h3>
            <p>基于真实钢琴音色和C大调音阶设计的Combo音效，带来优雅、丰富的听觉体验：</p>
            <ul>
                <li>真实钢琴音色（多谐波合成）</li>
                <li>基于C大调音阶的经典进行</li>
                <li>6连击以上添加钢琴琶音</li>
                <li>8连击以上添加钢琴颤音</li>
                <li>钢琴特有的快攻击慢衰减包络</li>
                <li>超低延迟，立即响应</li>
            </ul>
        </div>

        <div class="section">
            <h2>🎯 钢琴音阶Combo设计特点</h2>
            
            <div class="comparison-table">
                <thead>
                    <tr>
                        <th>连击数</th>
                        <th>旧设计</th>
                        <th>钢琴音阶设计</th>
                        <th>特殊效果</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>2连击</strong></td>
                        <td>单音A4 (440Hz)</td>
                        <td class="new-design">C4+E4钢琴和弦 (261+329Hz)</td>
                        <td>大三度和弦，0.6s持续</td>
                    </tr>
                    <tr>
                        <td><strong>3连击</strong></td>
                        <td>单音C5 (523Hz)</td>
                        <td class="new-design">D4+F#4钢琴和弦 (293+369Hz)</td>
                        <td>大三度和弦，0.7s持续</td>
                    </tr>
                    <tr>
                        <td><strong>4连击</strong></td>
                        <td>单音E5 (659Hz)</td>
                        <td class="new-design">E4+G#4钢琴和弦 (329+415Hz)</td>
                        <td>大三度和弦，0.8s持续</td>
                    </tr>
                    <tr>
                        <td><strong>5连击</strong></td>
                        <td>单音G5 (784Hz)</td>
                        <td class="new-design">F4+A4钢琴和弦 (349+440Hz)</td>
                        <td>大三度和弦，0.9s持续</td>
                    </tr>
                    <tr>
                        <td><strong>6连击</strong></td>
                        <td>单音A5 (880Hz)</td>
                        <td class="new-design">G4+B4钢琴和弦 (392+493Hz)</td>
                        <td>大三度和弦+钢琴琶音</td>
                    </tr>
                    <tr>
                        <td><strong>7连击</strong></td>
                        <td>单音C6 (1047Hz)</td>
                        <td class="new-design">A4+C#5钢琴和弦 (440+554Hz)</td>
                        <td>大三度和弦+钢琴琶音</td>
                    </tr>
                    <tr>
                        <td><strong>8连击</strong></td>
                        <td>单音E6 (1319Hz)</td>
                        <td class="new-design">B4+D#5钢琴和弦 (493+622Hz)</td>
                        <td>和弦+琶音+钢琴颤音</td>
                    </tr>
                    <tr>
                        <td><strong>9连击</strong></td>
                        <td>单音G6 (1568Hz)</td>
                        <td class="new-design">C5+E5钢琴和弦 (523+659Hz)</td>
                        <td>和弦+琶音+钢琴颤音</td>
                    </tr>
                    <tr>
                        <td><strong>10连击</strong></td>
                        <td>单音A6 (1760Hz)</td>
                        <td class="new-design">D5+F#5钢琴和弦 (587+739Hz)</td>
                        <td>和弦+琶音+钢琴颤音</td>
                    </tr>
                </tbody>
            </div>
        </div>

        <div class="section">
            <h2>🔊 音效特性</h2>
            
            <div class="audio-features">
                <div class="feature-card">
                    <h4>🎹 钢琴音色</h4>
                    <ul>
                        <li>多谐波合成真实钢琴音色</li>
                        <li>基频+2/3/4/5次谐波</li>
                        <li>钢琴特有的快攻击慢衰减</li>
                        <li>和弦音符错开0.1秒播放</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>🎼 C大调音阶</h4>
                    <ul>
                        <li>基于标准钢琴音符频率</li>
                        <li>C4-D5音阶渐进上升</li>
                        <li>每个连击都是大三度和弦</li>
                        <li>音量和持续时间渐进增长</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>🎵 琶音效果</h4>
                    <ul>
                        <li>6连击开始添加向上琶音</li>
                        <li>主音→和弦音→五度→八度</li>
                        <li>0.08秒间隔的流畅琶音</li>
                        <li>与主和弦形成立体层次</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>🎶 颤音效果</h4>
                    <ul>
                        <li>8连击开始添加钢琴颤音</li>
                        <li>快速交替两个半音</li>
                        <li>0.05秒颤音速度</li>
                        <li>营造激动的高潮感</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🎮 游戏测试</h2>
            
            <div class="info-box">
                <h3>📋 Combo音效测试步骤</h3>
                <ol>
                    <li>点击下方"加载TG3游戏"按钮</li>
                    <li>点击游戏区域激活音频</li>
                    <li>按Enter键开始游戏</li>
                    <li>故意制造连击，测试新音效</li>
                    <li>特别感受7连击以上的闪烁特效</li>
                </ol>
            </div>
            
            <div class="game-container">
                <button id="loadGame" class="combo-button">🎮 加载TG3游戏</button>
                <div id="gameFrame" style="display: none;">
                    <iframe id="tg3Game" class="game-frame" width="400" height="600" src=""></iframe>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>⚡ Combo音效测试</h2>
            
            <div class="warning-box">
                <h3>⚠️ 重要提示</h3>
                <p>在测试之前，请先点击游戏区域激活音频系统。然后点击下面的按钮测试不同连击的音效。</p>
            </div>
            
            <div class="combo-test">
                <button class="combo-button combo-2" onclick="testCombo(2)">🎹 2连击<br><small>C4+E4钢琴</small></button>
                <button class="combo-button combo-3" onclick="testCombo(3)">🎵 3连击<br><small>D4+F#4钢琴</small></button>
                <button class="combo-button combo-4" onclick="testCombo(4)">🎶 4连击<br><small>E4+G#4钢琴</small></button>
                <button class="combo-button combo-5" onclick="testCombo(5)">🎼 5连击<br><small>F4+A4钢琴</small></button>
                <button class="combo-button combo-6" onclick="testCombo(6)">🎵 6连击<br><small>G4+B4+琶音</small></button>
                <button class="combo-button combo-7" onclick="testCombo(7)">🎶 7连击<br><small>A4+C#5+琶音</small></button>
                <button class="combo-button combo-8" onclick="testCombo(8)">🎹 8连击<br><small>B4+D#5+颤音</small></button>
                <button class="combo-button combo-9" onclick="testCombo(9)">🎼 9连击<br><small>C5+E5+颤音</small></button>
                <button class="combo-button combo-10" onclick="testCombo(10)">🎵 10连击<br><small>D5+F#5+颤音</small></button>
                <button class="combo-button combo-high" onclick="testCombo(15)">🔥 超高连击<br><small>15连击测试</small></button>
            </div>
        </div>

        <div class="section">
            <h2>🎯 测试重点</h2>
            
            <div class="info-box">
                <h3>🎹 钢琴Combo音效验证</h3>
                <ul>
                    <li><strong>钢琴音色</strong>：是否能听到真实的钢琴音色（多谐波）？</li>
                    <li><strong>和弦进行</strong>：是否能感受到C大调音阶的和谐进行？</li>
                    <li><strong>琶音效果</strong>：6连击以上是否有优雅的琶音装饰？</li>
                    <li><strong>颤音效果</strong>：8连击以上是否有激动的钢琴颤音？</li>
                    <li><strong>音乐性</strong>：整体是否具有钢琴演奏的音乐感？</li>
                    <li><strong>响应速度</strong>：音效是否立即响应，无延迟？</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let audioSystem = null;
        let gameInstance = null;
        
        // 加载游戏
        document.getElementById('loadGame').addEventListener('click', function() {
            const gameFrame = document.getElementById('gameFrame');
            const tg3Game = document.getElementById('tg3Game');
            
            tg3Game.src = './TG3/index.html';
            gameFrame.style.display = 'block';
            
            // 监听iframe加载完成
            tg3Game.onload = function() {
                console.log('TG3游戏加载完成 - Combo音效测试模式');
                
                // 尝试获取iframe中的游戏实例
                try {
                    const iframeWindow = tg3Game.contentWindow;
                    if (iframeWindow && iframeWindow.game) {
                        gameInstance = iframeWindow.game;
                        audioSystem = gameInstance.audio;
                        console.log('游戏实例获取成功 - Combo音效测试模式');
                    }
                } catch (error) {
                    console.log('无法直接访问iframe游戏实例，将通过游戏测试');
                }
            };
        });
        
        // 测试Combo音效
        function testCombo(comboCount) {
            if (gameInstance && typeof gameInstance.playComboSound === 'function') {
                gameInstance.playComboSound(comboCount);
                console.log(`测试${comboCount}连击音效`);
            } else if (audioSystem) {
                // 备用方案：直接调用音频系统
                try {
                    // 模拟游戏实例的combo音效方法
                    testComboDirectly(comboCount);
                } catch (error) {
                    console.error('直接调用combo音效失败:', error);
                }
            } else {
                // 如果无法直接访问，提示用户通过游戏测试
                alert(`请在游戏中测试${comboCount}连击音效。\n\n操作说明：\n- 在游戏中制造连击\n- 观察新的和弦音效\n- 感受7连击以上的闪烁特效`);
            }
        }
        
        // 直接测试钢琴combo音效（备用方案）
        function testComboDirectly(comboCount) {
            if (!audioSystem || !audioSystem.audioContext) return;
            
            // 钢琴音阶连击音效配置
            const pianoComboConfig = {
                2: { notes: [261.63], chord: [329.63], duration: 0.6, volume: 0.25 },
                3: { notes: [293.66], chord: [369.99], duration: 0.7, volume: 0.3 },
                4: { notes: [329.63], chord: [415.30], duration: 0.8, volume: 0.35 },
                5: { notes: [349.23], chord: [440.00], duration: 0.9, volume: 0.4 },
                6: { notes: [392.00], chord: [493.88], duration: 1.0, volume: 0.45 },
                7: { notes: [440.00], chord: [554.37], duration: 1.1, volume: 0.5 },
                8: { notes: [493.88], chord: [622.25], duration: 1.2, volume: 0.55 },
                9: { notes: [523.25], chord: [659.25], duration: 1.3, volume: 0.6 },
                10: { notes: [587.33], chord: [739.99], duration: 1.4, volume: 0.65 }
            };
            
            const config = pianoComboConfig[Math.min(comboCount, 10)];
            const startTime = audioSystem.audioContext.currentTime;
            
            // 创建钢琴音色（简化版）
            createSimplePianoNote(config.notes[0], config.volume, config.duration, startTime);
            createSimplePianoNote(config.chord[0], config.volume * 0.7, config.duration, startTime + 0.1);
        }
        
        // 创建简化钢琴音符
        function createSimplePianoNote(frequency, volume, duration, startTime) {
            // 钢琴音色的基本谐波
            const harmonics = [
                { freq: frequency, vol: 1.0 },
                { freq: frequency * 2, vol: 0.3 },
                { freq: frequency * 3, vol: 0.15 }
            ];
            
            harmonics.forEach(harmonic => {
                const oscillator = audioSystem.audioContext.createOscillator();
                const gainNode = audioSystem.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioSystem.sfxGain);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(harmonic.freq, startTime);
                
                const noteVolume = volume * harmonic.vol;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(noteVolume, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(noteVolume * 0.3, startTime + duration * 0.5);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            });
        }
        
        // 页面加载完成后的提示
        window.addEventListener('load', function() {
            console.log('钢琴音阶Combo音效测试页面加载完成');
            console.log('新音效特点：');
            console.log('- 真实钢琴音色（多谐波合成）');
            console.log('- 基于C大调音阶的经典进行');
            console.log('- 6连击以上钢琴琶音效果');
            console.log('- 8连击以上钢琴颤音效果');
            console.log('- 钢琴特有的快攻击慢衰减');
            console.log('- 超低延迟立即响应');
        });
    </script>
</body>
</html>
