<!DOCTYPE html>
<html>
<head>
    <title>Leaderboard Deduplication Test</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #0f380f; 
            color: #00ff00; 
            padding: 20px; 
        }
        .test-btn { 
            background: #00ff00; 
            color: #0f380f; 
            border: none; 
            padding: 10px 20px; 
            margin: 10px; 
            cursor: pointer; 
        }
        .results {
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid #00ff00;
            font-size: 12px;
            line-height: 1.4;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #00ff00;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #306230;
        }
        .duplicate {
            background-color: #4a1a1a;
            text-decoration: line-through;
        }
        .kept {
            background-color: #1a4a1a;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🏆 排行榜去重功能测试</h1>
    
    <button class="test-btn" onclick="runBasicTest()">基础去重测试</button>
    <button class="test-btn" onclick="runEdgeCaseTest()">边界情况测试</button>
    <button class="test-btn" onclick="runPerformanceTest()">性能测试</button>
    <button class="test-btn" onclick="clearResults()">清除结果</button>
    
    <div id="results" class="results">
        <p>点击上方按钮开始测试...</p>
    </div>
    
    <script src="src/js/leaderboard.js"></script>
    <script>
        // 等待排行榜实例化
        setTimeout(() => {
            if (window.tetrisWorldLeaderboard) {
                console.log('✅ 排行榜实例已准备就绪');
            } else {
                console.error('❌ 排行榜实例未找到');
            }
        }, 100);

        function clearResults() {
            document.getElementById('results').innerHTML = '<p>结果已清除</p>';
        }

        function displayResults(title, original, deduplicated) {
            const results = document.getElementById('results');
            
            const originalTable = createTable(original, 'original');
            const deduplicatedTable = createTable(deduplicated, 'deduplicated');
            
            results.innerHTML = `
                <h3>${title}</h3>
                <h4>原始数据 (${original.length} 条记录):</h4>
                ${originalTable}
                <h4>去重后 (${deduplicated.length} 条记录):</h4>
                ${deduplicatedTable}
                <h4>统计信息:</h4>
                <p>• 移除重复记录: ${original.length - deduplicated.length} 条</p>
                <p>• 去重率: ${((original.length - deduplicated.length) / original.length * 100).toFixed(1)}%</p>
            `;
        }

        function createTable(data, type) {
            if (!data || data.length === 0) {
                return '<p>无数据</p>';
            }

            let html = `
                <table>
                    <tr>
                        <th>排名</th>
                        <th>玩家</th>
                        <th>分数</th>
                        <th>等级</th>
                        <th>行数</th>
                        <th>时间</th>
                    </tr>
            `;

            data.forEach((score, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${score.name || '(空)'}</td>
                        <td>${score.score}</td>
                        <td>${score.level}</td>
                        <td>${score.lines}</td>
                        <td>${score.duration}s</td>
                    </tr>
                `;
            });

            html += '</table>';
            return html;
        }

        function runBasicTest() {
            if (!window.tetrisWorldLeaderboard) {
                document.getElementById('results').innerHTML = '❌ 排行榜实例未准备就绪';
                return;
            }

            console.log('🧪 运行基础去重测试...');
            
            const testData = [
                { name: 'Alice', score: 15000, level: 5, lines: 45, duration: 180 },
                { name: 'alice', score: 12000, level: 4, lines: 35, duration: 150 }, // 同名小写，低分
                { name: 'Bob', score: 20000, level: 7, lines: 60, duration: 250 },
                { name: 'Alice ', score: 18000, level: 6, lines: 50, duration: 200 }, // 同名带空格，更高分
                { name: 'Charlie', score: 10000, level: 3, lines: 25, duration: 120 },
                { name: 'BOB', score: 20000, level: 7, lines: 60, duration: 250 }, // 同名大写，相同分数
                { name: 'David', score: 25000, level: 8, lines: 70, duration: 300 },
            ];

            const result = window.tetrisWorldLeaderboard.deduplicateScores(testData);
            displayResults('🔍 基础去重测试', testData, result);
        }

        function runEdgeCaseTest() {
            if (!window.tetrisWorldLeaderboard) {
                document.getElementById('results').innerHTML = '❌ 排行榜实例未准备就绪';
                return;
            }

            console.log('🧪 运行边界情况测试...');
            
            const testData = [
                { name: '', score: 30000, level: 9, lines: 80, duration: 350 }, // 空名称
                { name: '   ', score: 25000, level: 8, lines: 70, duration: 300 }, // 只有空格
                { name: 'Test', score: 0, level: 0, lines: 0, duration: 0 }, // 零分
                { name: 'TEST', score: 0, level: 0, lines: 0, duration: 0 }, // 同名零分
                { name: '中文名', score: 12000, level: 4, lines: 35, duration: 150 },
                { name: '中文名', score: 15000, level: 5, lines: 45, duration: 180 }, // 中文重复
                { name: 'VeryLongPlayerNameThatExceedsNormalLimits', score: 8000, level: 3, lines: 20, duration: 100 },
            ];

            const result = window.tetrisWorldLeaderboard.deduplicateScores(testData);
            displayResults('🔍 边界情况测试', testData, result);
        }

        function runPerformanceTest() {
            if (!window.tetrisWorldLeaderboard) {
                document.getElementById('results').innerHTML = '❌ 排行榜实例未准备就绪';
                return;
            }

            console.log('🧪 运行性能测试...');
            
            // 生成大量测试数据
            const testData = [];
            const names = ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace', 'Henry'];
            
            for (let i = 0; i < 1000; i++) {
                const name = names[Math.floor(Math.random() * names.length)];
                const variation = Math.random() < 0.3 ? name.toLowerCase() : 
                                  Math.random() < 0.1 ? name + ' ' : name;
                
                testData.push({
                    name: variation,
                    score: Math.floor(Math.random() * 50000),
                    level: Math.floor(Math.random() * 10) + 1,
                    lines: Math.floor(Math.random() * 100),
                    duration: Math.floor(Math.random() * 600) + 60
                });
            }

            const startTime = performance.now();
            const result = window.tetrisWorldLeaderboard.deduplicateScores(testData);
            const endTime = performance.now();

            document.getElementById('results').innerHTML = `
                <h3>⚡ 性能测试结果</h3>
                <p>• 原始记录数: ${testData.length}</p>
                <p>• 去重后记录数: ${result.length}</p>
                <p>• 移除重复: ${testData.length - result.length} 条</p>
                <p>• 处理时间: ${(endTime - startTime).toFixed(2)} ms</p>
                <p>• 处理速度: ${(testData.length / (endTime - startTime) * 1000).toFixed(0)} 条/秒</p>
            `;

            console.log(`📊 性能测试完成: ${testData.length} → ${result.length}, 耗时 ${(endTime - startTime).toFixed(2)}ms`);
        }
    </script>
</body>
</html>