<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¦œå•ä¿®å¤éªŒè¯å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f380f;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .test-btn {
            background: #00ff00;
            color: #0f380f;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }
        .test-btn:hover {
            background: #33ff33;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 3px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff4444;
        }
        .warning {
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† æ¦œå•ä¿®å¤éªŒè¯å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºéªŒè¯ä¸–ç•Œæ¦œå•æ•°æ®é—®é¢˜çš„ä¿®å¤æ•ˆæœ</p>

        <div class="test-section">
            <h2>ğŸ“Š é…ç½®éªŒè¯</h2>
            <button class="test-btn" onclick="testConfiguration()">æ£€æŸ¥é…ç½®ä¸€è‡´æ€§</button>
            <div id="config-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ® æ¨¡æ‹Ÿæ¸¸æˆæäº¤</h2>
            <button class="test-btn" onclick="simulateGameSubmission()">æ¨¡æ‹Ÿæˆç»©æäº¤</button>
            <button class="test-btn" onclick="testDuplicateSubmission()">æµ‹è¯•é‡å¤æäº¤ä¿æŠ¤</button>
            <div id="submission-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”„ æ¦œå•åˆ·æ–°æµ‹è¯•</h2>
            <button class="test-btn" onclick="testLeaderboardRefresh()">æµ‹è¯•æ¦œå•åˆ·æ–°</button>
            <button class="test-btn" onclick="checkDataConsistency()">æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§</button>
            <div id="refresh-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ—‘ï¸ å»é‡æœºåˆ¶æµ‹è¯•</h2>
            <button class="test-btn" onclick="testDeduplication()">æµ‹è¯•å»é‡é€»è¾‘</button>
            <div id="dedup-result" class="result"></div>
        </div>
    </div>

    <script>
        // ç­‰å¾…æ‰€æœ‰ç®¡ç†å™¨åˆå§‹åŒ–
        setTimeout(() => {
            console.log('=== æ¦œå•ä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½ ===');
            
            // åˆå§‹åŒ–æ‰€æœ‰ç®¡ç†å™¨
            try {
                if (!window.playerNameManager) {
                    window.playerNameManager = new PlayerNameManager();
                    console.log('âœ… PlayerNameManager å·²åˆå§‹åŒ–');
                } else {
                    console.log('âœ… PlayerNameManager å·²å­˜åœ¨');
                }
            } catch (e) {
                console.error('âŒ PlayerNameManager åˆå§‹åŒ–å¤±è´¥:', e);
            }
            
            try {
                if (!window.scoreSubmissionManager) {
                    window.scoreSubmissionManager = new ScoreSubmissionManager();
                    console.log('âœ… ScoreSubmissionManager å·²åˆå§‹åŒ–');
                } else {
                    console.log('âœ… ScoreSubmissionManager å·²å­˜åœ¨');
                }
            } catch (e) {
                console.error('âŒ ScoreSubmissionManager åˆå§‹åŒ–å¤±è´¥:', e);
            }
            
            try {
                if (!window.tetrisWorldLeaderboard) {
                    window.tetrisWorldLeaderboard = new TetrisWorldLeaderboard();
                    console.log('âœ… TetrisWorldLeaderboard å·²åˆå§‹åŒ–');
                } else {
                    console.log('âœ… TetrisWorldLeaderboard å·²å­˜åœ¨');
                }
            } catch (e) {
                console.error('âŒ TetrisWorldLeaderboard åˆå§‹åŒ–å¤±è´¥:', e);
            }
            
            // å†æ¬¡æ£€æŸ¥
            console.log('æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:');
            console.log('PlayerNameManager:', window.playerNameManager ? 'âœ…' : 'âŒ');
            console.log('ScoreSubmissionManager:', window.scoreSubmissionManager ? 'âœ…' : 'âŒ');
            console.log('TetrisWorldLeaderboard:', window.tetrisWorldLeaderboard ? 'âœ…' : 'âŒ');
        }, 2000);

        function testConfiguration() {
            const result = document.getElementById('config-result');
            let output = '=== é…ç½®ä¸€è‡´æ€§æ£€æŸ¥ ===\n\n';

            try {
                // æ£€æŸ¥ TW_CONFIG
                if (window.TW_CONFIG) {
                    output += `âœ… TW_CONFIG å·²åŠ è½½\n`;
                    output += `API_URL: ${window.TW_CONFIG.API_URL}\n`;
                } else {
                    output += `âŒ TW_CONFIG æœªåŠ è½½\n`;
                }

                // æ£€æŸ¥ ScoreSubmissionManager é…ç½®
                if (window.scoreSubmissionManager) {
                    output += `\n=== ScoreSubmissionManager é…ç½® ===\n`;
                    output += `API URL: ${window.scoreSubmissionManager.apiUrl}\n`;
                    output += `Spreadsheet ID: ${window.scoreSubmissionManager.spreadsheetId}\n`;
                    output += `Client Version: ${window.scoreSubmissionManager.clientVersion}\n`;
                    
                    // æ£€æŸ¥é…ç½®ä¸€è‡´æ€§
                    if (window.TW_CONFIG && window.scoreSubmissionManager.apiUrl === window.TW_CONFIG.API_URL) {
                        output += `âœ… API URL é…ç½®ä¸€è‡´\n`;
                    } else {
                        output += `âŒ API URL é…ç½®ä¸ä¸€è‡´\n`;
                    }
                }

                // æ£€æŸ¥ PlayerNameManager
                if (window.playerNameManager) {
                    output += `\n=== PlayerNameManager çŠ¶æ€ ===\n`;
                    output += `Player Name: ${window.playerNameManager.getPlayerName()}\n`;
                    output += `Player ID: ${window.playerNameManager.getPlayerId()}\n`;
                }

                result.className = 'result success';
            } catch (error) {
                output += `\nâŒ é…ç½®æ£€æŸ¥å¼‚å¸¸: ${error.message}\n`;
                result.className = 'result error';
            }

            result.textContent = output;
        }

        function simulateGameSubmission() {
            const result = document.getElementById('submission-result');
            let output = '=== æ¨¡æ‹Ÿæˆç»©æäº¤æµ‹è¯• ===\n\n';

            try {
                if (!window.scoreSubmissionManager) {
                    throw new Error('ScoreSubmissionManager ä¸å¯ç”¨');
                }

                // æ¨¡æ‹Ÿæ¸¸æˆæ•°æ®
                const mockGameData = {
                    score: Math.floor(Math.random() * 50000) + 1000,
                    level: Math.floor(Math.random() * 15) + 1,
                    lines: Math.floor(Math.random() * 100) + 10,
                    duration: Math.floor(Math.random() * 300000) + 60000,
                    playerName: window.playerNameManager ? window.playerNameManager.getPlayerName() : 'TestPlayer',
                    client_nonce: `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
                };

                output += `æµ‹è¯•æ•°æ®:\n`;
                output += `Score: ${mockGameData.score}\n`;
                output += `Level: ${mockGameData.level}\n`;
                output += `Lines: ${mockGameData.lines}\n`;
                output += `Player: ${mockGameData.playerName}\n`;
                output += `Nonce: ${mockGameData.client_nonce}\n\n`;

                // æ‰§è¡Œæäº¤
                window.scoreSubmissionManager.submitScore(mockGameData).then(submitResult => {
                    output += `æäº¤ç»“æœ: ${submitResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                    if (submitResult.success) {
                        output += `æ¶ˆæ¯: ${submitResult.message}\n`;
                    } else {
                        output += `é”™è¯¯: ${submitResult.error}\n`;
                    }
                    result.textContent = output;
                    result.className = submitResult.success ? 'result success' : 'result error';
                }).catch(error => {
                    output += `\nâŒ æäº¤å¼‚å¸¸: ${error.message}\n`;
                    result.textContent = output;
                    result.className = 'result error';
                });

                result.textContent = output + 'â³ æ­£åœ¨æäº¤...\n';
                result.className = 'result warning';

            } catch (error) {
                output += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}\n`;
                result.textContent = output;
                result.className = 'result error';
            }
        }

        function testDuplicateSubmission() {
            const result = document.getElementById('submission-result');
            let output = '=== é‡å¤æäº¤ä¿æŠ¤æµ‹è¯• ===\n\n';

            try {
                if (!window.scoreSubmissionManager) {
                    throw new Error('ScoreSubmissionManager ä¸å¯ç”¨');
                }

                // ç›¸åŒçš„æ¸¸æˆæ•°æ®ï¼ˆç›¸åŒçš„nonceï¼‰
                const stableNonce = `duplicate-test-${Date.now()}`;
                const duplicateGameData = {
                    score: 12345,
                    level: 5,
                    lines: 50,
                    duration: 180000,
                    playerName: window.playerNameManager ? window.playerNameManager.getPlayerName() : 'TestPlayer',
                    client_nonce: stableNonce
                };

                output += `ä½¿ç”¨ç¨³å®š Nonce: ${stableNonce}\n\n`;

                // ç¬¬ä¸€æ¬¡æäº¤
                output += `ç¬¬ä¸€æ¬¡æäº¤...\n`;
                result.textContent = output;

                window.scoreSubmissionManager.submitScore(duplicateGameData).then(firstResult => {
                    output += `ç¬¬ä¸€æ¬¡ç»“æœ: ${firstResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                    if (!firstResult.success) output += `é”™è¯¯: ${firstResult.error}\n`;
                    
                    // ç¬¬äºŒæ¬¡æäº¤ï¼ˆåº”è¯¥è¢«æ‹’ç»æˆ–è¯†åˆ«ä¸ºé‡å¤ï¼‰
                    output += `\nç¬¬äºŒæ¬¡æäº¤ï¼ˆæµ‹è¯•é‡å¤ä¿æŠ¤ï¼‰...\n`;
                    result.textContent = output;

                    return window.scoreSubmissionManager.submitScore(duplicateGameData);
                }).then(secondResult => {
                    output += `ç¬¬äºŒæ¬¡ç»“æœ: ${secondResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                    if (!secondResult.success) {
                        output += `é”™è¯¯: ${secondResult.error}\n`;
                        if (secondResult.error.includes('queued') || secondResult.error.includes('duplicate')) {
                            output += `âœ… é‡å¤æäº¤ä¿æŠ¤æœºåˆ¶å·¥ä½œæ­£å¸¸\n`;
                        }
                    }
                    result.textContent = output;
                    result.className = 'result success';
                }).catch(error => {
                    output += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}\n`;
                    result.textContent = output;
                    result.className = 'result error';
                });

                result.className = 'result warning';

            } catch (error) {
                output += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}\n`;
                result.textContent = output;
                result.className = 'result error';
            }
        }

        function testLeaderboardRefresh() {
            const result = document.getElementById('refresh-result');
            let output = '=== æ¦œå•åˆ·æ–°æµ‹è¯• ===\n\n';

            try {
                if (!window.tetrisWorldLeaderboard) {
                    throw new Error('TetrisWorldLeaderboard ä¸å¯ç”¨');
                }

                output += `æµ‹è¯•å¼ºåˆ¶åˆ·æ–°...\n`;
                result.textContent = output;

                // è®°å½•åˆ·æ–°å‰çš„æ•°æ®
                const beforeData = window.tetrisWorldLeaderboard.worldScores ? 
                    window.tetrisWorldLeaderboard.worldScores.length : 0;
                
                output += `åˆ·æ–°å‰è®°å½•æ•°: ${beforeData}\n`;

                // æ‰§è¡Œå¼ºåˆ¶åˆ·æ–°
                window.tetrisWorldLeaderboard.loadWorldScores({ silent: false }).then(() => {
                    const afterData = window.tetrisWorldLeaderboard.worldScores ? 
                        window.tetrisWorldLeaderboard.worldScores.length : 0;
                    
                    output += `åˆ·æ–°åè®°å½•æ•°: ${afterData}\n`;
                    output += `âœ… æ¦œå•åˆ·æ–°å®Œæˆ\n`;
                    
                    if (afterData > 0) {
                        output += `\nå‰3åç©å®¶:\n`;
                        const top3 = window.tetrisWorldLeaderboard.worldScores.slice(0, 3);
                        top3.forEach((player, index) => {
                            output += `${index + 1}. ${player.name}: ${player.score}\n`;
                        });
                    }
                    
                    result.textContent = output;
                    result.className = 'result success';
                }).catch(error => {
                    output += `âŒ åˆ·æ–°å¤±è´¥: ${error.message}\n`;
                    result.textContent = output;
                    result.className = 'result error';
                });

                result.className = 'result warning';

            } catch (error) {
                output += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}\n`;
                result.textContent = output;
                result.className = 'result error';
            }
        }

        function checkDataConsistency() {
            const result = document.getElementById('refresh-result');
            let output = '=== æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ ===\n\n';

            try {
                if (!window.tetrisWorldLeaderboard) {
                    throw new Error('TetrisWorldLeaderboard ä¸å¯ç”¨');
                }

                const scores = window.tetrisWorldLeaderboard.worldScores;
                if (!scores || scores.length === 0) {
                    output += `âŒ æ²¡æœ‰æ¦œå•æ•°æ®\n`;
                    result.textContent = output;
                    result.className = 'result error';
                    return;
                }

                output += `æ€»è®°å½•æ•°: ${scores.length}\n`;

                // æ£€æŸ¥é‡å¤ç©å®¶
                const playerNames = new Map();
                let duplicateCount = 0;

                scores.forEach((score, index) => {
                    const name = score.name ? score.name.toLowerCase().trim() : 'unknown';
                    if (playerNames.has(name)) {
                        duplicateCount++;
                        output += `âš ï¸  å‘ç°é‡å¤ç©å®¶: ${score.name} (ä½ç½® ${index + 1})\n`;
                    } else {
                        playerNames.set(name, true);
                    }
                });

                output += `\nå»é‡ç»Ÿè®¡:\n`;
                output += `å”¯ä¸€ç©å®¶æ•°: ${playerNames.size}\n`;
                output += `é‡å¤è®°å½•æ•°: ${duplicateCount}\n`;

                if (duplicateCount === 0) {
                    output += `âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®\n`;
                    result.className = 'result success';
                } else {
                    output += `âŒ å‘ç° ${duplicateCount} æ¡é‡å¤æ•°æ®\n`;
                    result.className = 'result warning';
                }

                result.textContent = output;

            } catch (error) {
                output += `âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}\n`;
                result.textContent = output;
                result.className = 'result error';
            }
        }

        function testDeduplication() {
            const result = document.getElementById('dedup-result');
            let output = '=== å»é‡æœºåˆ¶æµ‹è¯• ===\n\n';

            try {
                if (!window.tetrisWorldLeaderboard) {
                    throw new Error('TetrisWorldLeaderboard ä¸å¯ç”¨');
                }

                // æµ‹è¯•å‰ç«¯å»é‡åŠŸèƒ½
                const testData = [
                    { name: 'Alice', score: 1000, level: 5, lines: 20 },
                    { name: 'Alice', score: 1500, level: 6, lines: 25 }, // åŒåæ›´é«˜åˆ†
                    { name: 'Bob', score: 800, level: 4, lines: 15 },
                    { name: 'alice', score: 900, level: 4, lines: 18 }, // åŒåå°å†™
                    { name: 'Charlie', score: 1200, level: 5, lines: 22 }
                ];

                output += `æµ‹è¯•æ•°æ® (${testData.length} æ¡):\n`;
                testData.forEach((data, index) => {
                    output += `${index + 1}. ${data.name}: ${data.score}\n`;
                });

                // æ‰§è¡Œå»é‡
                const deduplicated = window.tetrisWorldLeaderboard.deduplicateScores(testData);
                
                output += `\nå»é‡åæ•°æ® (${deduplicated.length} æ¡):\n`;
                deduplicated.forEach((data, index) => {
                    output += `${index + 1}. ${data.name}: ${data.score}\n`;
                });

                // éªŒè¯ç»“æœ
                output += `\n=== éªŒè¯ç»“æœ ===\n`;
                const expectedNames = ['Alice', 'Bob', 'Charlie'];
                const actualNames = deduplicated.map(d => d.name);
                
                if (deduplicated.length === 3) {
                    output += `âœ… å»é‡åè®°å½•æ•°æ­£ç¡® (3æ¡)\n`;
                } else {
                    output += `âŒ å»é‡åè®°å½•æ•°é”™è¯¯ (æœŸæœ›3æ¡ï¼Œå®é™…${deduplicated.length}æ¡)\n`;
                }

                const aliceRecord = deduplicated.find(d => d.name.toLowerCase() === 'alice');
                if (aliceRecord && aliceRecord.score === 1500) {
                    output += `âœ… Alice ä¿ç•™äº†æœ€é«˜åˆ† (1500)\n`;
                } else {
                    output += `âŒ Alice åˆ†æ•°ä¸æ­£ç¡®\n`;
                }

                result.textContent = output;
                result.className = 'result success';

            } catch (error) {
                output += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}\n`;
                result.textContent = output;
                result.className = 'result error';
            }
        }
    </script>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="src/js/config.js"></script>
    <script src="src/js/player_name_manager.js"></script>
    <script src="src/js/score_submission.js"></script>
    <script src="src/js/leaderboard.js"></script>
</body>
</html>