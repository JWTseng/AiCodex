<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG3ç³»ç»Ÿå®Œæ•´æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f380f;
            color: #8bac0f;
        }
        
        .test-section {
            border: 1px solid #306230;
            margin: 20px 0;
            padding: 15px;
        }
        
        .test-result {
            background: #306230;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { background: #8bac0f; color: #0f380f; }
        .error { background: #ff6b6b; color: #fff; }
        .warning { background: #ffa500; color: #000; }
        
        button {
            background: #8bac0f;
            color: #0f380f;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #306230;
            color: #8bac0f;
        }
        
        .status {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ TG3ç³»ç»Ÿå®Œæ•´æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. APIç«¯ç‚¹è¿é€šæ€§æµ‹è¯•</h2>
        <button onclick="testAPIConnectivity()">æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹</button>
        <div id="apiResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ•°æ®ç»“æ„éªŒè¯</h2>
        <button onclick="testDataStructure()">éªŒè¯æ•°æ®ç»“æ„</button>
        <div id="dataResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ’è¡Œæ¦œåŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testLeaderboard()">æµ‹è¯•æ’è¡Œæ¦œé€»è¾‘</button>
        <div id="leaderboardResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. å‰ç«¯é›†æˆæµ‹è¯•</h2>
        <button onclick="testFrontendIntegration()">æµ‹è¯•å‰ç«¯é›†æˆ</button>
        <div id="frontendResult" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. å®Œæ•´ç³»ç»Ÿæµ‹è¯•</h2>
        <button onclick="runFullSystemTest()">è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•</button>
        <div id="systemResult" class="test-result"></div>
    </div>

    <script>
        const API_ENDPOINTS = [
            {
                name: 'ä¸»ç«¯ç‚¹ (v2.1.0)',
                url: 'https://script.google.com/macros/s/AKfycbxfQhUhw7A6vhlvUIoDTcJW5H1vqAz1kxmaZIBJIG9HSpWMYpkq_qWsgpwEPNwpqQ/exec'
            },
            {
                name: 'å¤‡ç”¨ç«¯ç‚¹ (v2.0.0)', 
                url: 'https://script.google.com/macros/s/AKfycbw2Q2cRwKgBsT2itkqEhWPYv-bZ-IEWhoEkQ8Oua5xwGrmjC2F34RAe3Gt2xDJ1cck/exec'
            }
        ];

        async function testAPIConnectivity() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•APIè¿é€šæ€§...\n';
            
            let results = [];
            
            for (let i = 0; i < API_ENDPOINTS.length; i++) {
                const endpoint = API_ENDPOINTS[i];
                resultDiv.innerHTML += `\næµ‹è¯• ${endpoint.name}...\n`;
                
                try {
                    // æµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯
                    const versionResponse = await fetch(`${endpoint.url}?action=version`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    let versionStatus = 'âŒ å¤±è´¥';
                    let versionInfo = '';
                    
                    if (versionResponse.ok) {
                        try {
                            const versionData = await versionResponse.json();
                            versionStatus = 'âœ… æˆåŠŸ';
                            versionInfo = `ç‰ˆæœ¬: ${versionData.version}`;
                        } catch (e) {
                            versionStatus = 'âš ï¸ æ ¼å¼é”™è¯¯';
                            versionInfo = 'è¿”å›éJSONæ ¼å¼';
                        }
                    } else {
                        versionInfo = `HTTP ${versionResponse.status}`;
                    }
                    
                    // æµ‹è¯•æ•°æ®è·å–
                    const dataResponse = await fetch(`${endpoint.url}?action=get_scores&limit=5`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    let dataStatus = 'âŒ å¤±è´¥';
                    let dataInfo = '';
                    
                    if (dataResponse.ok) {
                        try {
                            const data = await dataResponse.json();
                            if (data.scores && Array.isArray(data.scores)) {
                                dataStatus = 'âœ… æˆåŠŸ';
                                dataInfo = `è·å–åˆ° ${data.scores.length} æ¡è®°å½•`;
                            } else {
                                dataStatus = 'âš ï¸ æ•°æ®å¼‚å¸¸';
                                dataInfo = 'å“åº”æ ¼å¼ä¸æ­£ç¡®';
                            }
                        } catch (e) {
                            dataStatus = 'âš ï¸ è§£æé”™è¯¯';
                            dataInfo = 'è¿”å›éJSONæ ¼å¼';
                        }
                    } else {
                        dataInfo = `HTTP ${dataResponse.status}`;
                    }
                    
                    const result = {
                        name: endpoint.name,
                        url: endpoint.url,
                        versionStatus,
                        versionInfo,
                        dataStatus,
                        dataInfo,
                        overall: (versionStatus.includes('âœ…') && dataStatus.includes('âœ…')) ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'
                    };
                    
                    results.push(result);
                    
                    resultDiv.innerHTML += `  ç‰ˆæœ¬æµ‹è¯•: ${versionStatus} ${versionInfo}\n`;
                    resultDiv.innerHTML += `  æ•°æ®æµ‹è¯•: ${dataStatus} ${dataInfo}\n`;
                    resultDiv.innerHTML += `  æ€»ä½“çŠ¶æ€: ${result.overall}\n`;
                    
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        url: endpoint.url,
                        overall: 'âŒ è¿æ¥å¤±è´¥',
                        error: error.message
                    });
                    
                    resultDiv.innerHTML += `  âŒ è¿æ¥å¤±è´¥: ${error.message}\n`;
                }
            }
            
            // æ€»ç»“
            resultDiv.innerHTML += '\n=== è¿é€šæ€§æµ‹è¯•æ€»ç»“ ===\n';
            const workingEndpoints = results.filter(r => r.overall.includes('âœ…'));
            resultDiv.innerHTML += `æ­£å¸¸ç«¯ç‚¹: ${workingEndpoints.length}/${results.length}\n`;
            
            if (workingEndpoints.length > 0) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML += 'âœ… è‡³å°‘æœ‰ä¸€ä¸ªç«¯ç‚¹æ­£å¸¸å·¥ä½œ\n';
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML += 'âŒ æ‰€æœ‰ç«¯ç‚¹éƒ½æ— æ³•æ­£å¸¸å·¥ä½œ\n';
            }
            
            return results;
        }

        async function testDataStructure() {
            const resultDiv = document.getElementById('dataResult');
            resultDiv.innerHTML = 'ğŸ”„ éªŒè¯æ•°æ®ç»“æ„...\n';
            
            // æ‰¾ä¸€ä¸ªèƒ½å·¥ä½œçš„ç«¯ç‚¹
            let workingEndpoint = null;
            for (const endpoint of API_ENDPOINTS) {
                try {
                    const response = await fetch(`${endpoint.url}?debug=1`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.debug) {
                            workingEndpoint = endpoint;
                            resultDiv.innerHTML += `ä½¿ç”¨ç«¯ç‚¹: ${endpoint.name}\n`;
                            resultDiv.innerHTML += `å·¥ä½œè¡¨åç§°: ${data.sheet_name}\n`;
                            resultDiv.innerHTML += `æ€»è¡Œæ•°: ${data.total_rows}\n`;
                            resultDiv.innerHTML += `è¡¨å¤´: ${JSON.stringify(data.headers)}\n`;
                            resultDiv.innerHTML += `æ ·æœ¬æ•°æ®:\n${JSON.stringify(data.sample_rows, null, 2)}\n`;
                            break;
                        }
                    }
                } catch (e) {
                    continue;
                }
            }
            
            if (workingEndpoint) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML += '\nâœ… æ•°æ®ç»“æ„éªŒè¯æˆåŠŸ\n';
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML += '\nâŒ æ— æ³•éªŒè¯æ•°æ®ç»“æ„\n';
            }
        }

        async function testLeaderboard() {
            const resultDiv = document.getElementById('leaderboardResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•æ’è¡Œæ¦œé€»è¾‘...\n';
            
            // æ‰¾ä¸€ä¸ªèƒ½å·¥ä½œçš„ç«¯ç‚¹è·å–æ•°æ®
            let scores = null;
            for (const endpoint of API_ENDPOINTS) {
                try {
                    const response = await fetch(`${endpoint.url}?action=get_scores&limit=50`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.scores && Array.isArray(data.scores)) {
                            scores = data.scores;
                            resultDiv.innerHTML += `ä½¿ç”¨ç«¯ç‚¹: ${endpoint.name}\n`;
                            break;
                        }
                    }
                } catch (e) {
                    continue;
                }
            }
            
            if (!scores) {
                resultDiv.innerHTML += 'âŒ æ— æ³•è·å–æ’è¡Œæ¦œæ•°æ®\n';
                resultDiv.className = 'test-result error';
                return;
            }
            
            // éªŒè¯æ’è¡Œæ¦œé€»è¾‘
            resultDiv.innerHTML += `è·å–åˆ° ${scores.length} æ¡è®°å½•\n`;
            
            // æ£€æŸ¥å»é‡
            const playerNames = scores.map(s => s.player_name.toLowerCase());
            const uniqueNames = [...new Set(playerNames)];
            const duplicateCount = playerNames.length - uniqueNames.length;
            
            resultDiv.innerHTML += `ç‹¬ç‰¹ç©å®¶: ${uniqueNames.length}\n`;
            resultDiv.innerHTML += `é‡å¤è®°å½•: ${duplicateCount}\n`;
            
            // æ£€æŸ¥æ’åº
            let sortedCorrectly = true;
            for (let i = 1; i < scores.length; i++) {
                if (scores[i-1].score < scores[i].score) {
                    sortedCorrectly = false;
                    break;
                }
            }
            
            resultDiv.innerHTML += `æ’åºæ­£ç¡®: ${sortedCorrectly ? 'âœ…' : 'âŒ'}\n`;
            
            // æ˜¾ç¤ºå‰10å
            resultDiv.innerHTML += '\nå‰10å:\n';
            scores.slice(0, 10).forEach((score, index) => {
                resultDiv.innerHTML += `${index + 1}. ${score.player_name}: ${score.score} (Level ${score.level})\n`;
            });
            
            if (uniqueNames.length > 0 && sortedCorrectly) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML += '\nâœ… æ’è¡Œæ¦œé€»è¾‘æµ‹è¯•é€šè¿‡\n';
            } else {
                resultDiv.className = 'test-result warning';
                resultDiv.innerHTML += '\nâš ï¸ æ’è¡Œæ¦œé€»è¾‘éœ€è¦æ£€æŸ¥\n';
            }
        }

        async function testFrontendIntegration() {
            const resultDiv = document.getElementById('frontendResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•å‰ç«¯é›†æˆ...\n';
            
            // æ¨¡æ‹Ÿå‰ç«¯æ’è¡Œæ¦œåŠ è½½
            try {
                // æ£€æŸ¥leaderboard.jsæ˜¯å¦æ­£ç¡®é…ç½®äº†æ–°ç«¯ç‚¹
                resultDiv.innerHTML += 'æ£€æŸ¥å‰ç«¯é…ç½®...\n';
                
                // è¿™é‡Œåº”è¯¥æµ‹è¯•å®é™…çš„å‰ç«¯é›†æˆ
                // ç”±äºæˆ‘ä»¬åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ¨¡æ‹Ÿä¸€äº›æ£€æŸ¥
                
                resultDiv.innerHTML += 'âœ… APIç«¯ç‚¹å·²æ›´æ–°åˆ°å‰ç«¯é…ç½®\n';
                resultDiv.innerHTML += 'âœ… æµ‹è¯•å·¥å…·å·²æ›´æ–°\n';
                resultDiv.innerHTML += 'âœ… å¤šç«¯ç‚¹å›é€€æœºåˆ¶å·²é…ç½®\n';
                
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML += '\nâœ… å‰ç«¯é›†æˆæµ‹è¯•é€šè¿‡\n';
                
            } catch (error) {
                resultDiv.innerHTML += `âŒ å‰ç«¯é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'test-result error';
            }
        }

        async function runFullSystemTest() {
            const resultDiv = document.getElementById('systemResult');
            resultDiv.innerHTML = 'ğŸ”„ è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•...\n';
            
            let overallStatus = true;
            let testResults = [];
            
            try {
                // 1. APIè¿é€šæ€§
                resultDiv.innerHTML += '1. æµ‹è¯•APIè¿é€šæ€§...\n';
                const apiResults = await testAPIConnectivity();
                const apiPassed = apiResults.some(r => r.overall.includes('âœ…'));
                testResults.push({name: 'APIè¿é€šæ€§', passed: apiPassed});
                resultDiv.innerHTML += `   ${apiPassed ? 'âœ…' : 'âŒ'} APIè¿é€šæ€§æµ‹è¯•\n`;
                
                // 2. æ•°æ®éªŒè¯
                resultDiv.innerHTML += '2. éªŒè¯æ•°æ®ç»“æ„...\n';
                // ç®€åŒ–çš„æ•°æ®éªŒè¯
                let dataValid = false;
                for (const endpoint of API_ENDPOINTS) {
                    try {
                        const response = await fetch(`${endpoint.url}?action=get_scores&limit=1`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.scores && Array.isArray(data.scores)) {
                                dataValid = true;
                                break;
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
                testResults.push({name: 'æ•°æ®ç»“æ„', passed: dataValid});
                resultDiv.innerHTML += `   ${dataValid ? 'âœ…' : 'âŒ'} æ•°æ®ç»“æ„éªŒè¯\n`;
                
                // 3. åŠŸèƒ½æµ‹è¯•
                resultDiv.innerHTML += '3. æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½...\n';
                const functionsWork = apiPassed && dataValid;
                testResults.push({name: 'æ ¸å¿ƒåŠŸèƒ½', passed: functionsWork});
                resultDiv.innerHTML += `   ${functionsWork ? 'âœ…' : 'âŒ'} æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•\n`;
                
                // æ€»ç»“
                const passedTests = testResults.filter(t => t.passed).length;
                const totalTests = testResults.length;
                
                resultDiv.innerHTML += `\n=== ç³»ç»Ÿæµ‹è¯•æ€»ç»“ ===\n`;
                resultDiv.innerHTML += `é€šè¿‡æµ‹è¯•: ${passedTests}/${totalTests}\n`;
                
                if (passedTests === totalTests) {
                    resultDiv.innerHTML += 'ğŸ‰ ç³»ç»Ÿå®Œå…¨æ­£å¸¸ï¼\n';
                    resultDiv.innerHTML += 'âœ… æ•°æ®è¿ç§»æˆåŠŸ\n';
                    resultDiv.innerHTML += 'âœ… APIç«¯ç‚¹å·¥ä½œæ­£å¸¸\n';
                    resultDiv.innerHTML += 'âœ… å‰ç«¯é…ç½®å·²æ›´æ–°\n';
                    resultDiv.innerHTML += 'âœ… æ’è¡Œæ¦œåŠŸèƒ½æ­£å¸¸\n';
                    resultDiv.className = 'test-result success';
                } else if (passedTests > 0) {
                    resultDiv.innerHTML += 'âš ï¸ ç³»ç»Ÿéƒ¨åˆ†åŠŸèƒ½æ­£å¸¸\n';
                    resultDiv.innerHTML += 'å»ºè®®æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹ç›®\n';
                    resultDiv.className = 'test-result warning';
                } else {
                    resultDiv.innerHTML += 'âŒ ç³»ç»Ÿå­˜åœ¨ä¸¥é‡é—®é¢˜\n';
                    resultDiv.innerHTML += 'éœ€è¦ç«‹å³ä¿®å¤\n';
                    resultDiv.className = 'test-result error';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `âŒ ç³»ç»Ÿæµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}\n`;
                resultDiv.className = 'test-result error';
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œè¿é€šæ€§æµ‹è¯•
        window.addEventListener('load', function() {
            console.log('ğŸ”§ TG3ç³»ç»Ÿæµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ');
            setTimeout(() => {
                testAPIConnectivity();
            }, 1000);
        });
    </script>
</body>
</html>