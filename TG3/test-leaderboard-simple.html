<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–æ¦œå•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f380f;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-btn {
            background: #00ff00;
            color: #0f380f;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 3px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #00ff00;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .leaderboard-table th,
        .leaderboard-table td {
            border: 1px solid #00ff00;
            padding: 8px;
            text-align: left;
        }
        .leaderboard-table th {
            background-color: #306230;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† ç®€åŒ–æ¦œå•æµ‹è¯•</h1>
        
        <button class="test-btn" onclick="loadAndDisplayLeaderboard()">åŠ è½½å¹¶æ˜¾ç¤ºæ¦œå•</button>
        <button class="test-btn" onclick="testDirectAPI()">ç›´æ¥APIæµ‹è¯•</button>
        <button class="test-btn" onclick="clearResult()">æ¸…é™¤ç»“æœ</button>
        
        <div id="result" class="result">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...
        </div>
        
        <table class="leaderboard-table" id="leaderboard-display" style="display: none;">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>ç©å®¶</th>
                    <th>åˆ†æ•°</th>
                    <th>ç­‰çº§</th>
                    <th>è¡Œæ•°</th>
                    <th>æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="src/js/config.js"></script>
    <script src="src/js/player_name_manager.js"></script>
    <script src="src/js/score_submission.js"></script>
    <script src="src/js/leaderboard.js"></script>

    <script>
        let testLeaderboard = null;
        
        // ç­‰å¾…è„šæœ¬åŠ è½½
        setTimeout(() => {
            try {
                // æ‰‹åŠ¨åˆå§‹åŒ–æ¦œå•
                testLeaderboard = new TetrisWorldLeaderboard();
                console.log('âœ… æµ‹è¯•æ¦œå•å·²åˆå§‹åŒ–');
            } catch (error) {
                console.error('âŒ æ¦œå•åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }, 1000);

        function clearResult() {
            document.getElementById('result').textContent = 'ç»“æœå·²æ¸…é™¤';
            document.getElementById('leaderboard-display').style.display = 'none';
        }

        async function loadAndDisplayLeaderboard() {
            const result = document.getElementById('result');
            let output = '=== åŠ è½½æ¦œå•æµ‹è¯• ===\n\n';
            
            try {
                if (!testLeaderboard) {
                    throw new Error('æ¦œå•æœªåˆå§‹åŒ–');
                }
                
                output += 'æ­£åœ¨åŠ è½½æ¦œå•æ•°æ®...\n';
                result.textContent = output;
                
                // ä½¿ç”¨ä¿®å¤åçš„åŠ è½½æ–¹æ³•
                await testLeaderboard.loadWorldScores({ silent: false });
                
                const scores = testLeaderboard.worldScores;
                
                output += `\n=== åŠ è½½ç»“æœ ===\n`;
                output += `æ€»è®°å½•æ•°: ${scores ? scores.length : 0}\n`;
                
                if (scores && scores.length > 0) {
                    output += `\nå‰10å:\n`;
                    scores.slice(0, 10).forEach((score, index) => {
                        output += `${index + 1}. ${score.name}: ${score.score} (Lv.${score.level})\n`;
                    });
                    
                    // æ˜¾ç¤ºè¡¨æ ¼
                    displayLeaderboardTable(scores);
                    
                    // æ£€æŸ¥é‡å¤ç©å®¶
                    const playerNames = new Map();
                    let duplicateCount = 0;
                    scores.forEach(score => {
                        const name = score.name.toLowerCase().trim();
                        if (playerNames.has(name)) {
                            duplicateCount++;
                        } else {
                            playerNames.set(name, true);
                        }
                    });
                    
                    output += `\n=== å»é‡åˆ†æ ===\n`;
                    output += `å”¯ä¸€ç©å®¶æ•°: ${playerNames.size}\n`;
                    output += `é‡å¤è®°å½•æ•°: ${duplicateCount}\n`;
                    
                    if (duplicateCount === 0) {
                        output += `âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®\n`;
                    } else {
                        output += `âš ï¸ å‘ç° ${duplicateCount} æ¡é‡å¤æ•°æ®\n`;
                    }
                } else {
                    output += `âŒ æ²¡æœ‰è·å–åˆ°æ¦œå•æ•°æ®\n`;
                }
                
                result.textContent = output;
                
            } catch (error) {
                output += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                result.textContent = output;
            }
        }

        async function testDirectAPI() {
            const result = document.getElementById('result');
            let output = '=== ç›´æ¥APIæµ‹è¯• ===\n\n';
            
            try {
                const apiUrl = window.TW_CONFIG?.API_URL || 'https://script.google.com/macros/s/AKfycbw9oCs3E9iPT2u2IukGvg_36MHjcjYxtdqaYGzd4zv0NNU9VrllIpiBqF5u6_I0bwE/exec';
                
                output += `APIåœ°å€: ${apiUrl}\n\n`;
                output += 'æ­£åœ¨è¯·æ±‚æ•°æ®...\n';
                result.textContent = output;
                
                const response = await fetch(`${apiUrl}?action=get_scores&limit=50`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                output += `APIå“åº”çŠ¶æ€: ${response.status}\n`;
                output += `å“åº”æ•°æ®:\n`;
                output += `- ç‰ˆæœ¬: ${data.version || 'æœªçŸ¥'}\n`;
                output += `- è®°å½•æ•°: ${data.scores ? data.scores.length : 0}\n`;
                output += `- æ—¶é—´æˆ³: ${data.timestamp || 'æœªçŸ¥'}\n`;
                
                if (data.scores && data.scores.length > 0) {
                    output += `\nåŸå§‹æ•°æ®å‰5æ¡:\n`;
                    data.scores.slice(0, 5).forEach((score, index) => {
                        output += `${index + 1}. ${score.player_name}: ${score.score}\n`;
                    });
                    
                    // åˆ†ææ•°æ®
                    const playerNames = new Map();
                    let duplicateCount = 0;
                    data.scores.forEach(score => {
                        const name = (score.player_name || '').toLowerCase().trim();
                        if (playerNames.has(name)) {
                            duplicateCount++;
                        } else {
                            playerNames.set(name, true);
                        }
                    });
                    
                    output += `\n=== APIæ•°æ®åˆ†æ ===\n`;
                    output += `å”¯ä¸€ç©å®¶æ•°: ${playerNames.size}\n`;
                    output += `é‡å¤è®°å½•æ•°: ${duplicateCount}\n`;
                    
                    if (duplicateCount === 0) {
                        output += `âœ… APIè¿”å›çš„æ•°æ®å·²å»é‡\n`;
                    } else {
                        output += `âš ï¸ APIè¿”å›çš„æ•°æ®åŒ…å«é‡å¤\n`;
                    }
                }
                
                result.textContent = output;
                
            } catch (error) {
                output += `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}\n`;
                result.textContent = output;
            }
        }

        function displayLeaderboardTable(scores) {
            const table = document.getElementById('leaderboard-display');
            const tbody = document.getElementById('leaderboard-body');
            
            tbody.innerHTML = '';
            
            scores.forEach((score, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${score.name}</td>
                    <td>${score.score.toString().padStart(7, '0')}</td>
                    <td>${score.level}</td>
                    <td>${score.lines}</td>
                    <td>${formatTime(score.duration)}</td>
                `;
                
                if (index === 0) {
                    row.style.color = '#ffd700';
                    row.style.fontWeight = 'bold';
                }
            });
            
            table.style.display = 'table';
        }

        function formatTime(durationMs) {
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>