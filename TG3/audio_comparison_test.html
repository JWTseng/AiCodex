<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频对比测试 - 线上版本 vs 当前版本</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f380f;
            color: #8bac0f;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #306230;
            border: 2px solid #8bac0f;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .test-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffffff;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-item {
            background: #0f380f;
            border: 1px solid #8bac0f;
            padding: 15px;
            border-radius: 5px;
        }
        .test-item h3 {
            margin: 0 0 10px 0;
            color: #ffffff;
        }
        .test-button {
            background: #8bac0f;
            color: #0f380f;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        .test-button:hover {
            background: #9bbc0f;
        }
        .test-button:disabled {
            background: #306230;
            color: #8bac0f;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #0f380f;
            color: #8bac0f;
            border: 1px solid #8bac0f;
        }
        .status.error {
            background: #380f0f;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .status.info {
            background: #0f0f38;
            color: #6b6bff;
            border: 1px solid #6b6bff;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #8bac0f;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: #306230;
            color: #ffffff;
        }
        .comparison-table tr:nth-child(even) {
            background: #0f380f;
        }
        .comparison-table tr:nth-child(odd) {
            background: #1a4a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 音频对比测试 - 线上版本 vs 当前版本</h1>
        
        <div class="test-section">
            <div class="test-title">📊 音频参数对比</div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>音效类型</th>
                        <th>线上版本参数</th>
                        <th>当前版本参数</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>移动音效 (move)</td>
                        <td>600Hz, 80ms, 正弦波, 快速衰减</td>
                        <td>600Hz, 50ms, 基础衰减</td>
                        <td id="move-status">待测试</td>
                    </tr>
                    <tr>
                        <td>旋转音效 (rotate)</td>
                        <td>800Hz, 100ms, 三角波, 精确衰减</td>
                        <td>800Hz, 80ms, 基础衰减</td>
                        <td id="rotate-status">待测试</td>
                    </tr>
                    <tr>
                        <td>锁定音效 (lock)</td>
                        <td>200Hz, 150ms, 正弦波, 自然衰减</td>
                        <td>200Hz, 150ms, 基础衰减</td>
                        <td id="lock-status">待测试</td>
                    </tr>
                    <tr>
                        <td>消行音效 (line)</td>
                        <td>1000Hz→1500Hz, 200ms, 正弦波, 频率上升</td>
                        <td>1000Hz→1500Hz, 200ms, 正弦波, 频率上升</td>
                        <td id="line-status">待测试</td>
                    </tr>
                    <tr>
                        <td>升级音效 (levelup)</td>
                        <td>500Hz→1200Hz, 500ms, 正弦波, 频率上升</td>
                        <td>500Hz→1200Hz, 500ms, 正弦波, 频率上升</td>
                        <td id="levelup-status">待测试</td>
                    </tr>
                    <tr>
                        <td>游戏结束 (gameover)</td>
                        <td>300Hz→80Hz, 600ms, 正弦波, 频率下降</td>
                        <td>300Hz→80Hz, 600ms, 正弦波, 频率下降</td>
                        <td id="gameover-status">待测试</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <div class="test-title">🎮 基础音效测试</div>
            <div class="test-grid">
                <div class="test-item">
                    <h3>移动音效</h3>
                    <button class="test-button" onclick="testSFX('move')">播放 Move SFX</button>
                    <div id="move-result" class="status info">点击按钮测试移动音效</div>
                </div>
                <div class="test-item">
                    <h3>旋转音效</h3>
                    <button class="test-button" onclick="testSFX('rotate')">播放 Rotate SFX</button>
                    <div id="rotate-result" class="status info">点击按钮测试旋转音效</div>
                </div>
                <div class="test-item">
                    <h3>锁定音效</h3>
                    <button class="test-button" onclick="testSFX('lock')">播放 Lock SFX</button>
                    <div id="lock-result" class="status info">点击按钮测试锁定音效</div>
                </div>
                <div class="test-item">
                    <h3>软降落地（softlock）</h3>
                    <button class="test-button" onclick="testSFX('softlock')">播放 Soft Lock</button>
                    <div id="softlock-result" class="status info">点击按钮测试软降落地</div>
                </div>
                <div class="test-item">
                    <h3>硬降落地（hardlock）</h3>
                    <button class="test-button" onclick="testSFX('hardlock')">播放 Hard Lock</button>
                    <div id="hardlock-result" class="status info">点击按钮测试硬降落地</div>
                </div>
                <div class="test-item">
                    <h3>消行音效</h3>
                    <button class="test-button" onclick="testSFX('line')">播放 Line SFX</button>
                    <div id="line-result" class="status info">点击按钮测试消行音效</div>
                </div>
                <div class="test-item">
                    <h3>升级音效</h3>
                    <button class="test-button" onclick="testSFX('levelup')">播放 Levelup SFX</button>
                    <div id="levelup-result" class="status info">点击按钮测试升级音效</div>
                </div>
                <div class="test-item">
                    <h3>游戏结束</h3>
                    <button class="test-button" onclick="testSFX('gameover')">播放 Gameover SFX</button>
                    <div id="gameover-result" class="status info">点击按钮测试游戏结束音效</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">🎵 连击音效测试</div>
            <div class="test-grid">
                <div class="test-item">
                    <h3>连击音效 (2连击)</h3>
                    <button class="test-button" onclick="testCombo(2)">播放 2x Combo</button>
                    <div id="combo2-result" class="status info">点击按钮测试2连击音效</div>
                </div>
                <div class="test-item">
                    <h3>连击音效 (5连击)</h3>
                    <button class="test-button" onclick="testCombo(5)">播放 5x Combo</button>
                    <div id="combo5-result" class="status info">点击按钮测试5连击音效</div>
                </div>
                <div class="test-item">
                    <h3>连击音效 (8连击)</h3>
                    <button class="test-button" onclick="testCombo(8)">播放 8x Combo</button>
                    <div id="combo8-result" class="status info">点击按钮测试8连击音效</div>
                </div>
                <div class="test-item">
                    <h3>压哨"叮"声</h3>
                    <button class="test-button" onclick="testClutchDing()">播放 Clutch Ding</button>
                    <div id="clutch-result" class="status info">点击按钮测试压哨"叮"声</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">⚡ 延迟测试</div>
            <div class="test-grid">
                <div class="test-item">
                    <h3>响应延迟测试</h3>
                    <button class="test-button" onclick="testLatency()">开始延迟测试</button>
                    <div id="latency-result" class="status info">点击按钮开始延迟测试</div>
                </div>
                <div class="test-item">
                    <h3>连续播放测试</h3>
                    <button class="test-button" onclick="testContinuous()">开始连续播放</button>
                    <div id="continuous-result" class="status info">点击按钮开始连续播放测试</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">📈 测试结果总结</div>
            <div id="summary-result" class="status info">
                完成所有测试后，这里将显示详细的对比结果和建议
            </div>
        </div>
    </div>

    <script src="audio_manager.js"></script>
    <script>
        let audioManager = null;
        let testResults = {};

        // 初始化音频管理器
        function initAudio() {
            if (!audioManager) {
                audioManager = new GlobalAudioManager();
                console.log('音频管理器已初始化');
            }
        }

        // 测试基础音效
        async function testSFX(type) {
            initAudio();
            const resultElement = document.getElementById(`${type}-result`);
            const statusElement = document.getElementById(`${type}-status`);
            
            try {
                const startTime = performance.now();
                await audioManager.playSFX(type);
                const endTime = performance.now();
                const latency = endTime - startTime;
                
                resultElement.className = 'status success';
                resultElement.textContent = `✅ 播放成功 - 延迟: ${latency.toFixed(2)}ms`;
                
                if (statusElement) {
                    statusElement.textContent = '✅ 已对齐';
                    statusElement.style.color = '#8bac0f';
                }
                
                testResults[type] = { success: true, latency };
            } catch (error) {
                resultElement.className = 'status error';
                resultElement.textContent = `❌ 播放失败: ${error.message}`;
                
                if (statusElement) {
                    statusElement.textContent = '❌ 未对齐';
                    statusElement.style.color = '#ff6b6b';
                }
                
                testResults[type] = { success: false, error: error.message };
            }
        }

        // 测试连击音效
        function testCombo(comboCount) {
            initAudio();
            const resultElement = document.getElementById(`combo${comboCount}-result`);
            
            try {
                // 模拟连击音效生成
                const startTime = performance.now();
                generateComboSFX(comboCount);
                const endTime = performance.now();
                const latency = endTime - startTime;
                
                resultElement.className = 'status success';
                resultElement.textContent = `✅ ${comboCount}连击音效播放成功 - 延迟: ${latency.toFixed(2)}ms`;
                
                testResults[`combo${comboCount}`] = { success: true, latency };
            } catch (error) {
                resultElement.className = 'status error';
                resultElement.textContent = `❌ ${comboCount}连击音效播放失败: ${error.message}`;
                
                testResults[`combo${comboCount}`] = { success: false, error: error.message };
            }
        }

        // 测试压哨"叮"声
        function testClutchDing() {
            initAudio();
            const resultElement = document.getElementById('clutch-result');
            
            try {
                const startTime = performance.now();
                playClutchDing();
                const endTime = performance.now();
                const latency = endTime - startTime;
                
                resultElement.className = 'status success';
                resultElement.textContent = `✅ 压哨"叮"声播放成功 - 延迟: ${latency.toFixed(2)}ms`;
                
                testResults.clutch = { success: true, latency };
            } catch (error) {
                resultElement.className = 'status error';
                resultElement.textContent = `❌ 压哨"叮"声播放失败: ${error.message}`;
                
                testResults.clutch = { success: false, error: error.message };
            }
        }

        // 模拟连击音效生成（简化版）
        function generateComboSFX(comboCount) {
            if (!audioManager || !audioManager.audioContext) return;
            
            const ctx = audioManager.audioContext;
            const startTime = ctx.currentTime;
            
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioManager.sfxGain);
            
            // 简化的连击音效
            const freq = 261.63 + (comboCount - 2) * 50;
            oscillator.frequency.setValueAtTime(freq, startTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + 0.5);
        }

        // 模拟压哨"叮"声
        function playClutchDing() {
            if (!audioManager || !audioManager.audioContext) return;
            
            const ctx = audioManager.audioContext;
            const now = ctx.currentTime;
            
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(2000, now);
            
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.35, now + 0.006);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.18);
            
            osc.connect(gain).connect(audioManager.sfxGain);
            
            osc.start(now);
            osc.stop(now + 0.2);
        }

        // 延迟测试
        async function testLatency() {
            initAudio();
            const resultElement = document.getElementById('latency-result');
            
            const latencies = [];
            const testCount = 10;
            
            resultElement.className = 'status info';
            resultElement.textContent = '🔄 正在进行延迟测试...';
            
            for (let i = 0; i < testCount; i++) {
                const startTime = performance.now();
                await audioManager.playSFX('move');
                const endTime = performance.now();
                latencies.push(endTime - startTime);
                
                // 等待一小段时间
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const avgLatency = latencies.reduce((a, b) => a + b, 0) / latencies.length;
            const maxLatency = Math.max(...latencies);
            const minLatency = Math.min(...latencies);
            
            resultElement.className = 'status success';
            resultElement.textContent = `✅ 延迟测试完成 - 平均: ${avgLatency.toFixed(2)}ms, 最大: ${maxLatency.toFixed(2)}ms, 最小: ${minLatency.toFixed(2)}ms`;
            
            testResults.latency = { avgLatency, maxLatency, minLatency };
        }

        // 连续播放测试
        async function testContinuous() {
            initAudio();
            const resultElement = document.getElementById('continuous-result');
            
            resultElement.className = 'status info';
            resultElement.textContent = '🔄 正在进行连续播放测试...';
            
            const sfxTypes = ['move', 'rotate', 'lock', 'line'];
            let successCount = 0;
            let totalCount = 20;
            
            for (let i = 0; i < totalCount; i++) {
                try {
                    const type = sfxTypes[i % sfxTypes.length];
                    await audioManager.playSFX(type);
                    successCount++;
                } catch (error) {
                    console.error('连续播放测试失败:', error);
                }
                
                // 短暂等待
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const successRate = (successCount / totalCount) * 100;
            
            resultElement.className = successRate >= 95 ? 'status success' : 'status error';
            resultElement.textContent = `✅ 连续播放测试完成 - 成功率: ${successRate.toFixed(1)}% (${successCount}/${totalCount})`;
            
            testResults.continuous = { successRate, successCount, totalCount };
        }

        // 生成测试总结
        function generateSummary() {
            const summaryElement = document.getElementById('summary-result');
            
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success !== false).length;
            const successRate = totalTests > 0 ? (successfulTests / totalTests) * 100 : 0;
            
            let summary = `📊 测试总结 - 总测试: ${totalTests}, 成功: ${successfulTests}, 成功率: ${successRate.toFixed(1)}%\n\n`;
            
            // 延迟分析
            if (testResults.latency) {
                const { avgLatency, maxLatency, minLatency } = testResults.latency;
                summary += `⚡ 延迟性能:\n`;
                summary += `   - 平均延迟: ${avgLatency.toFixed(2)}ms\n`;
                summary += `   - 最大延迟: ${maxLatency.toFixed(2)}ms\n`;
                summary += `   - 最小延迟: ${minLatency.toFixed(2)}ms\n`;
                
                if (avgLatency < 10) {
                    summary += `   ✅ 延迟表现优秀（< 10ms）\n`;
                } else if (avgLatency < 20) {
                    summary += `   ⚠️ 延迟表现良好（10-20ms）\n`;
                } else {
                    summary += `   ❌ 延迟表现较差（> 20ms）\n`;
                }
                summary += '\n';
            }
            
            // 音效对齐状态
            const sfxTypes = ['move', 'rotate', 'lock', 'line', 'levelup', 'gameover'];
            summary += `🎵 音效对齐状态:\n`;
            sfxTypes.forEach(type => {
                const result = testResults[type];
                if (result && result.success) {
                    summary += `   ✅ ${type}: 已对齐 (${result.latency?.toFixed(2)}ms)\n`;
                } else {
                    summary += `   ❌ ${type}: 未对齐\n`;
                }
            });
            
            summaryElement.className = successRate >= 80 ? 'status success' : 'status error';
            summaryElement.textContent = summary;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            
            // 5秒后自动生成总结
            setTimeout(generateSummary, 5000);
        });
    </script>
</body>
</html>
